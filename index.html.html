<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夸夸你 (AI 增强版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Noto Sans 和 Noto Sans SC 字体 (根据 NFR1) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 根据 NFR1 应用字体 */
        body {
            font-family: 'Noto Sans', 'Noto Sans SC', sans-serif;
        }

        /* 夸奖文本的淡入淡出动画 (根据 F1.3) */
        .compliment-display {
            transition: opacity 0.3s ease-in-out;
        }
        .compliment-display.fade-out {
            opacity: 0;
        }
        .compliment-display.fade-in {
            opacity: 1;
        }

        /* 加载中 spinner (根据 F2.3.1) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f59e0b; /* 温暖的黄色 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<!-- 根据 NFR1 使用温暖的色调 -->
<body class="bg-yellow-50 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-lg">
        
        <!-- 语言切换 (根据 F3) -->
        <div class="flex justify-center space-x-4 mb-6">
            <button id="lang-zh" class="lang-btn text-sm font-medium text-gray-500 hover:text-yellow-600 transition">中文</button>
            <button id="lang-en" class="lang-btn text-sm font-medium text-gray-500 hover:text-yellow-600 transition">English</button>
            <button id="lang-es" class="lang-btn text-sm font-medium text-gray-500 hover:text-yellow-600 transition">Español</button>
        </div>

        <!-- 标题和副标题 -->
        <h1 id="main-title" class="text-3xl font-bold text-center text-gray-800">夸夸你</h1>
        <p id="subtitle" class="text-center text-gray-500 mt-2 mb-8">在你的屏幕上捕捉一点温暖。</p>

        <!-- 夸奖显示区域 -->
        <div class="h-32 bg-yellow-50 rounded-lg p-6 flex items-center justify-center text-center">
            <div id="compliment-display" class="compliment-display text-lg text-yellow-800 font-medium fade-in">
                <!-- 初始内容将由 JS 填充 -->
            </div>
        </div>

        <!-- F1: 随机夸奖功能 -->
        <button id="random-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg mt-8 transition duration-200 shadow-md">
            换一句随机夸奖
        </button>

        <!-- F2: AI 专属夸奖功能 -->
        <div class="mt-8 border-t pt-6">
            <label for="ai-prompt" id="ai-label" class="block text-sm font-medium text-gray-700">需要一点专属夸奖？</label>
            <input type="text" id="ai-prompt" class="w-full border border-gray-300 rounded-lg p-3 mt-2 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="告诉 AI 你想夸奖谁/什么事...">
            <button id="ai-btn" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg mt-3 transition duration-200">
                <span id="ai-btn-text">生成专属夸奖</span>
                <span id="ai-btn-loading" class="hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="ai-loading-text">生成中...</span>
                </span>
            </button>
        </div>

    </div>

    <script>
        // --- 1. DOM 元素 ---
        const complimentDisplay = document.getElementById('compliment-display');
        const randomBtn = document.getElementById('random-btn');
        const aiBtn = document.getElementById('ai-btn');
        const aiBtnText = document.getElementById('ai-btn-text');
        const aiBtnLoading = document.getElementById('ai-btn-loading');
        const aiLoadingText = document.getElementById('ai-loading-text');
        const aiPromptInput = document.getElementById('ai-prompt');
        const langBtns = {
            zh: document.getElementById('lang-zh'),
            en: document.getElementById('lang-en'),
            es: document.getElementById('lang-es')
        };
        const uiElements = {
            title: document.getElementById('main-title'),
            subtitle: document.getElementById('subtitle'),
            randomBtn: document.getElementById('random-btn'),
            aiLabel: document.getElementById('ai-label'),
            aiPromptPlaceholder: document.getElementById('ai-prompt'),
            aiBtnText: document.getElementById('ai-btn-text'),
            aiLoadingText: document.getElementById('ai-loading-text')
        };

        // --- 2. 翻译与夸奖库 (根据 F1.3 & F3.3) ---
        const translations = {
            'zh': {
                title: '夸夸你',
                subtitle: '在你的屏幕上捕捉一点温暖。',
                randomBtn: '换一句随机夸奖',
                aiLabel: '需要一点专属夸奖？',
                aiPromptPlaceholder: '告诉 AI 你想夸奖谁/什么事...',
                aiBtnText: '生成专属夸奖',
                aiLoadingText: 'AI 正在思考中...',
                loading: 'AI 正在思考中...',
                error: '哎呀，生成失败了。请稍后再试！',
                aiSystemPrompt: '你是一个世界级的“夸夸”专家和一个温暖的朋友。请根据用户提供的情境，用中文生成一句简短（1-2句）、真诚、并且充满创意的夸奖。你的回答必须直接是那句夸奖，不要任何多余的开头或结尾。',
                compliments: [
                    "你真的太棒了，坚持就是胜利！", "你的笑容能点亮一整天！", "你比你想象的还要优秀！",
                    "今天也是努力发光的一天呢！", "你的想法总是那么有创意！", "和你聊天总是很开心！",
                    "你身上有一种让人安心的魔力。", "你做出的选择总是那么明智！", "为你的小小成就欢呼！",
                    "你付出的努力，一定会有回报的！", "你真是个细节天才！", "你的善良和温柔值得被世界珍视。",
                    "你超有品味的！", "仅仅是做你自己，就已经很了不起了。"
                ]
            },
            'en': {
                title: 'Compliment You',
                subtitle: 'Capture a little warmth on your screen.',
                randomBtn: 'Get Another Compliment',
                aiLabel: 'Need a personalized compliment?',
                aiPromptPlaceholder: 'Tell AI who/what you want to praise...',
                aiBtnText: 'Generate Compliment',
                aiLoadingText: 'AI is thinking...',
                loading: 'AI is thinking...',
                error: 'Oops, something went wrong. Please try again!',
                aiSystemPrompt: 'You are a world-class "compliment" expert and a warm friend. Based on the context provided by the user, generate a short (1-2 sentences), sincere, and creative compliment in English. Your response must be *only* the compliment itself, with no extra intro or outro.',
                compliments: [
                    "You are doing an amazing job!", "Your smile is contagious!", "You are more capable than you know.",
                    "You're shining bright today!", "Your ideas are incredibly creative!", "I always enjoy talking to you!",
                    "You have a wonderful, calming presence.", "You make such wise choices!", "Cheering for your wins, big or small!",
                    "Your hard work is definitely going to pay off!", "You have an amazing eye for detail!",
                    "Your kindness and gentleness are precious.", "You have fantastic taste!",
                    "Just by being you, you're already doing great."
                ]
            },
            'es': {
                title: 'Te Elogio',
                subtitle: 'Captura un poco de calidez en tu pantalla.',
                randomBtn: 'Obtener Otro Elogio',
                aiLabel: '¿Necesitas un elogio personalizado?',
                aiPromptPlaceholder: 'Dile a la IA a quién/qué quieres elogiar...',
                aiBtnText: 'Generar Elogio',
                aiLoadingText: 'IA está pensando...',
                loading: 'IA está pensando...',
                error: '¡Uy! Algo salió mal. ¡Inténtalo de nuevo!',
                aiSystemPrompt: 'Eres un experto "elogiador" de clase mundial y un amigo cálido. Basado en el contexto proporcionado por el usuario, genera un elogio corto (1-2 frases), sincero y creativo en español. Tu respuesta debe ser *solo* el elogio en sí, sin introducción ni conclusión adicional.',
                compliments: [
                    "¡Estás haciendo un trabajo increíble!", "¡Tu sonrisa es contagiosa!", "Eres más capaz de lo que crees.",
                    "¡Estás brillando hoy!", "¡Tus ideas son increíblemente creativas!", "¡Siempre disfruto hablar contigo!",
                    "Tienes una presencia maravillosa y tranquilizadora.", "¡Tomas decisiones muy sabias!",
                    "¡Celebrando tus logros, grandes o pequeños!", "¡Tu arduo trabajo definitivamente valdrá la pena!",
                    "¡Tienes un ojo increíble para los detalles!", "Tu amabilidad y gentileza son preciosas.",
                    "¡Tienes un gusto fantástico!", "Simplemente siendo tú, ya lo estás haciendo genial."
                ]
            }
        };

        let currentLanguage = 'zh'; // 默认语言
        let isAILoading = false; // AI 加载状态 (根据 F2.3.1)

        // --- 3. 核心功能 ---

        /**
         * F3.3.1: 更新所有 UI 静态文本
         */
        function updateUI(lang) {
            if (!translations[lang]) return;
            currentLanguage = lang;
            const t = translations[lang];

            // 更新文本
            uiElements.title.textContent = t.title;
            uiElements.subtitle.textContent = t.subtitle;
            uiElements.randomBtn.textContent = t.randomBtn;
            uiElements.aiLabel.textContent = t.aiLabel;
            uiElements.aiPromptPlaceholder.placeholder = t.aiPromptPlaceholder;
            uiElements.aiBtnText.textContent = t.aiBtnText;
            uiElements.aiLoadingText.textContent = t.aiLoadingText;

            // 更新语言按钮激活状态 (根据 F3.3)
            Object.values(langBtns).forEach(btn => {
                btn.classList.remove('text-yellow-600', 'font-bold');
                btn.classList.add('text-gray-500');
            });
            langBtns[lang].classList.add('text-yellow-600', 'font-bold');
            langBtns[lang].classList.remove('text-gray-500');

            // 切换语言时自动获取一句新的随机夸奖 (根据 F3.3.2)
            getRandomCompliment();
        }

        /**
         * F1.3: 带动效的夸奖展示
         */
        function displayCompliment(text, isLoading = false) {
            complimentDisplay.classList.remove('fade-in');
            complimentDisplay.classList.add('fade-out');

            setTimeout(() => {
                if (isLoading) {
                    complimentDisplay.innerHTML = `<div class="flex flex-col items-center justify-center">
                        <div class="loader"></div>
                        <span class="mt-2 text-sm text-yellow-700">${text}</span>
                    </div>`;
                } else {
                    complimentDisplay.innerHTML = `<span class="text-lg text-yellow-800 font-medium">${text}</span>`;
                }
                complimentDisplay.classList.remove('fade-out');
                complimentDisplay.classList.add('fade-in');
            }, 300); // 必须匹配 CSS transition 时间
        }

        /**
         * F1: 获取随机夸奖
         */
        function getRandomCompliment() {
            if (isAILoading) return; // AI 加载时不执行
            const complimentList = translations[currentLanguage].compliments;
            const randomIndex = Math.floor(Math.random() * complimentList.length);
            displayCompliment(complimentList[randomIndex]);
        }

        /**
         * F2: 获取 AI 专属夸奖
         */
        async function getAiCompliment() {
            if (isAILoading) return;

            const promptText = aiPromptInput.value.trim();
            if (!promptText) {
                // 如果输入为空，可以给个提示或抖动效果，这里我们选择直接获取一句随机的
                getRandomCompliment();
                return;
            }

            // F2.3.1: 设置加载状态
            isAILoading = true;
            aiBtn.disabled = true;
            aiBtnText.classList.add('hidden');
            aiBtnLoading.classList.remove('hidden');
            displayCompliment(translations[currentLanguage].loading, true);

            // --- Gemini API 调用 ---
            const apiKey = "AIzaSyC5_Ut8bBjo-cG86RKAG3u9bITFG81Ej6c"; // Canvas 将自动注入
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = translations[currentLanguage].aiSystemPrompt;
            const userQuery = promptText;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let retries = 3;
            let delay = 1000;
            let success = false;

            while (retries > 0 && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const aiText = candidate?.content?.parts?.[0]?.text;

                    if (aiText) {
                        // F2.3.2: 成功状态
                        displayCompliment(aiText);
                        success = true;
                    } else {
                        throw new Error('Invalid API response structure');
                    }

                } catch (error) {
                    console.error('API call failed:', error);
                    retries--;
                    if (retries === 0) {
                        // F2.3.3: 失败状态
                        displayCompliment(translations[currentLanguage].error);
                    } else {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            // 恢复按钮状态
            isAILoading = false;
            aiBtn.disabled = false;
            aiBtnText.classList.remove('hidden');
            aiBtnLoading.classList.add('hidden');
        }


        // --- 4. 事件监听 ---
        window.addEventListener('DOMContentLoaded', () => {
            // 初始化
            updateUI(currentLanguage);

            // F1: 随机按钮
            randomBtn.addEventListener('click', getRandomCompliment);

            // F2: AI 按钮
            aiBtn.addEventListener('click', getAiCompliment);

            // F3: 语言切换按钮
            langBtns.zh.addEventListener('click', () => updateUI('zh'));
            langBtns.en.addEventListener('click', () => updateUI('en'));
            langBtns.es.addEventListener('click', () => updateUI('es'));
        });

    </script>
</body>

</html>

